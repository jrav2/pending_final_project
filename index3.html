<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EV Charging Station Finder — Washington</title>

<link rel="icon" type="image/png" href="imgs/favicon.png">

<!-- Main CSS (navbar + content styles) -->
<link rel="stylesheet" href="css/main.css">

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Mapbox CSS & JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
    /* Optional: top controls for search/input */
    .sidebar {
        position: absolute;
        width: 25%;
        height: 525px;
        top: 250px;
        left: 0;
        padding: 1rem;
        overflow-y: scroll;
        background-color: #f4f3e7;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        z-index: 100;
    }

        /* Map sizing */
    #map {
        width: 75%;
        left: 25%;
        /*height: 600px;*/ /* same height as Leaflet page */
        height: 525px;/*Changed so map doesn't bleed past page*/
        /*margin-top: 20px;*/
             /* leaves space for navbar */

        z-index: 10;
    }

    .title {
        background: rgba(255,255,255,0.95);
        padding: 10px 14px;
        border-radius: 8px;
        font-weight: 700;
        color: #1f2937;
        box-shadow: 0 4px 14px rgba(2,6,23,0.08);
    }

    /* Listing area in the sidebar */
    .store-count { margin-top: 8px; font-weight: 700; }
    .listings { margin-top: 8px; }
    .store-item { padding: 8px; border-radius:6px; background: #fff; margin-bottom:8px; box-shadow: 0 2px 6px rgba(2,6,23,0.06); cursor: pointer }
    .store-item:hover { transform: translateY(-2px); }
    .store-name { margin:0 0 4px 0; font-size:14px }
    .store-details { font-size:13px; color:#334155 }

    .search {
        display: flex;
        align-items: center;
        background: rgba(255,255,255,0.95);
        padding: 6px;
        border-radius: 8px;
        box-shadow: 0 4px 14px rgba(2,6,23,0.08);
    }

    .search input { border:0; outline:none; padding:6px 8px; width:260px; font-size:14px }
    .search button { border:0; background:#2563eb; color:white; padding:6px 10px; border-radius:6px; cursor:pointer; margin-left:6px }

    /* Info box at bottom */
    .info {
        position: fixed;
        left: 50%;
        bottom: 22px;
        transform: translateX(-50%);
        z-index: 1400;
        padding: 12px 18px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 6px 24px rgba(16,24,40,0.16);
        display: none;
        font-weight: 600;
    }

    /* Ensure navbar is on top */
    .topnav { z-index: 1500; }
</style>

</head>
<body>

<!-- Navigation Bar -->
<div class="topnav" id="myTopnav">
    <a href="index.html">Our Project</a>
    <a href="index2.html">Public EV Charging Stations</a>

    <a class="active" href="index3.html">EV Charging Station Finder</a>
    
    <a href="index4.html">EV Charging Station Density</a>
    <a href="index5.html">EV Chargers by Type & Power Level</a>

    <a href="javascript:void(0);" class="icon">
        <i class="fa fa-bars"></i>
    </a>
</div>

<!-- Page content heading -->
<div class="content">
    <h2>EV Charging Station Finder — Washington</h2>
    <p>Click on the map or search a location to find the nearest EV charging station.</p>
</div>

<!-- Map container -->
<div id="map"></div>

<!-- Topbar for search -->
<div class="sidebar">
    <div class="title">Search a Location</div>
    <div class="search">
        <input id="searchInput" placeholder="Search location or address" aria-label="Search location" />
        <button id="searchBtn">Search</button>
    </div>

    <div id="store-count" class="store-count">Stations: 0</div>
    <div id="listings" class="listings" aria-live="polite"></div>
</div>

<!-- Info box -->
<div id="info" class="info"></div>

<script>
    // Mapbox token
    //mapboxgl.accessToken = 'pk.eyJ1IjoibWpvdSIsImEiOiJjbWh5ZWZ6N2gwYWluMmptdTVlczZ5NXEzIn0.Ha9WIGJy4xJyUiZSR5xbNg';
    mapboxgl.accessToken = 'pk.eyJ1Ijoiam9oYW5ucjIiLCJhIjoiY21obDBicm84MTN6MzJxb3EyaTk2MzcyOCJ9.QQ-NbzYXscnvoU23EgUcyw'

    // Initialize Mapbox map centered on Washington
    const map = new mapboxgl.Map({
        container: 'map',
        //style: 'mapbox://styles/mapbox/streets-v12',
        style: 'mapbox://styles/johannr2/cmip03uix00n201r96oa0c6ba',
        center: [-120.5, 47.5],
        zoom: 7
    });

    const WA_BBOX = [-124.846, 45.544, -116.915, 49.002]; // Washington bounds
    let stations = [];

    function removeLayerIfExists(id) {
        if (map.getLayer(id)) map.removeLayer(id);
        if (map.getSource(id)) map.removeSource(id);
    }

    // Small helper to escape HTML when inserting property text into the sidebar
    function escapeHtml(str) {
        if (!str && str !== 0) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Build the sidebar location list from the `stations` array
    function buildLocationList() {
        const listings = document.getElementById('listings');
        const storeCount = document.getElementById('store-count');
        if (!listings || !storeCount) return;

        // Update count
        storeCount.textContent = `Stations: ${stations.length}`;

        // Clear existing
        listings.innerHTML = '';

        stations.forEach((feature, index) => {
            const props = feature.properties || {};
            const name = props.Station_Na || props.StationName || props.name || 'Unnamed Station';
            const addr = props.Address || props.address || '';
            const city = props.City || props.CityName || '';

            const listing = document.createElement('div');
            listing.className = 'store-item';
            listing.dataset.index = index;
            listing.innerHTML = `
                <h4 class="store-name">${escapeHtml(name)}</h4>
                <div class="store-details">${escapeHtml(addr)} ${escapeHtml(city)}</div>
            `;

            listing.addEventListener('click', () => {
                if (feature.geometry && feature.geometry.coordinates) {
                    const [lng, lat] = feature.geometry.coordinates;
                    map.flyTo({ center: [lng, lat], zoom: 14 });
                    handleLocation(lng, lat);
                }
            });

            listings.appendChild(listing);
        });
    }

    function handleLocation(lng, lat) {
        if (!stations.length) return;
        const clickPoint = turf.point([lng, lat]);
        const stationsCollection = turf.featureCollection(stations);
        const nearest = turf.nearestPoint(clickPoint, stationsCollection);
        const distance = turf.distance(clickPoint, nearest, { units: 'miles' });

        // Click marker
        removeLayerIfExists('click-point');
        map.addSource('click-point', { type: 'geojson', data: clickPoint });
        map.addLayer({
            id: 'click-point',
            type: 'circle',
            source: 'click-point',
            paint: {
                'circle-radius': 10,
                'circle-color': '#2196F3',
                'circle-stroke-width': 2,
                'circle-stroke-color': '#1565C0',
                'circle-opacity': 0.95
            }
        });

        // Highlight nearest station
        removeLayerIfExists('closest-station');
        map.addSource('closest-station', { type: 'geojson', data: nearest });
        map.addLayer({
            id: 'closest-station',
            type: 'circle',
            source: 'closest-station',
            paint: {
                'circle-radius': 12,
                'circle-color': '#FF9800',
                'circle-stroke-width': 3,
                'circle-stroke-color': '#E65100',
                'circle-opacity': 1
            }
        });

        // Show info
        const info = document.getElementById('info');
        const name = nearest.properties && (nearest.properties.Station_Na || nearest.properties.StationName || 'Unnamed');
        info.innerHTML = `Closest station: <strong>${name}</strong> — <strong>${distance.toFixed(2)} miles</strong>`;
        info.style.display = 'block';
    }

    async function geocode(query) {
        if (!query) return null;
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&limit=1`;
        try {
            const res = await fetch(url);
            const json = await res.json();
            if (json && json.features && json.features.length) return json.features[0];
        } catch (err) { console.error('Geocode error', err); }
        return null;
    }

    map.on('load', async () => {
        map.fitBounds([[WA_BBOX[0], WA_BBOX[1]], [WA_BBOX[2], WA_BBOX[3]]], { padding: 40 });

        
        // Load EV stations GeoJSON
        try {
            const resp = await fetch('./assets/Public_EV_Charging_Stations.geojson');
            const geojson = await resp.json();
            stations = geojson.features;

            // Add stations to map
            map.addSource('stations', { type: 'geojson', data: geojson });
            map.addLayer({
                id: 'stations-layer',
                type: 'circle',
                source: 'stations',
                paint: {
                    'circle-radius': 6,
                    'circle-color': '#4CAF50',
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#2E7D32',
                    'circle-opacity': 0.95
                }
            });

            // Populate the sidebar list now that stations are loaded
            try { buildLocationList(); } catch (e) { console.warn('buildLocationList failed', e); }

          
        } catch (err) {
            console.error('Failed to load stations', err);
        }
    });

    // Map click handler
    map.on('click', (e) => handleLocation(e.lngLat.lng, e.lngLat.lat));

    // Search button
    document.getElementById('searchBtn').addEventListener('click', async () => {
        const q = document.getElementById('searchInput').value.trim();
        if (!q) return;
        const result = await geocode(q);
        if (!result) { alert('Location not found'); return; }
        const [lng, lat] = result.center;
        map.flyTo({ center: [lng, lat], zoom: 12 });
        setTimeout(() => handleLocation(lng, lat), 400);
    });

    // Enter key triggers search
    document.getElementById('searchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') document.getElementById('searchBtn').click();
    });
</script>
</body>
</html>
